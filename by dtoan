-- ===== Services =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ===== Load Dtoan GUI =====
local Dtoan = loadstring(game:HttpGet('https://raw.githubusercontent.com/duytoan429/Menu/refs/heads/main/sourcebydtoan.lua.txt'))()
local Window = Dtoan:CreateWindow({
    Name = "Dtoan",
    Icon = 0,
    LoadingTitle = "Dtoan",
    Theme = "Default",
    ToggleUIKeybind = "K",
    DisableDtoanPrompts = false,
    DisableBuildWarnings = false,
    ConfigurationSaving = {Enabled = true, FolderName = nil, FileName = "Dtoan Hub"},
    Discord = {Enabled = false, Invite = "https://discord.gg/9Xhw2AMKw", RememberJoins = true},
    KeySystem = false,
    KeySettings = {Title = "Untitled", FileName = "Key", SaveKey = true, GrabKeyFromSite = false, Key = {"Hello"}}
})

-- ===== Tabs Blox Fruit =====
local BloxFruitTab = Window:CreateTab("Blox Fruit", 4483362458)
BloxFruitTab:CreateButton({Name = "Speed Hub", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/AhmadV99/Speed-Hub-X/main/Speed%20Hub%20X.lua"))() end})
BloxFruitTab:CreateButton({Name = "Teddy Hub", Callback = function() repeat task.wait() until game:IsLoaded() and game.Players.LocalPlayer:FindFirstChild("PlayerGui") loadstring(game:HttpGet("https://raw.githubusercontent.com/Teddyseetink/Haidepzai/refs/heads/main/TEDDYHUB-FREEMIUM"))() end})
BloxFruitTab:CreateButton({Name = "Kiwi Hub", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/HieuDepTrai-Z/KiwiHubFree/refs/heads/main/KiwiHub.lua"))() end})
BloxFruitTab:CreateButton({Name = "Doraemon Hub", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/KiddoHiru/BloxFruits/main/MasterHub.lua"))() end})
BloxFruitTab:CreateButton({Name = "Zee Hub", Callback = function() loadstring(game:HttpGet("https://zuwz.me/Ls-Zee-Hub"))() end})
BloxFruitTab:CreateButton({Name = "Đạt Thg", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/LuaCrack/DatThg/refs/heads/main/DatThgV2"))() end})
BloxFruitTab:CreateButton({Name = "Maru Hub", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/trongdeptraihucscript/MaruHubPremium/refs/heads/main/MaruHubPremium.lua"))() end})
BloxFruitTab:CreateButton({Name = "W Azure", Callback = function() loadstring(game:HttpGet("https://api.luarmor.net/files/v3/loaders/85e904ae1ff30824c1aa007fc7324f8f.lua"))() end})
BloxFruitTab:CreateButton({Name = "Quantum Hub", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/flazhy/QuantumOnyx/refs/heads/main/QuantumOnyx.lua"))() end})
BloxFruitTab:CreateButton({Name = "Astral Hub", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/Overgustx2/Main/refs/heads/main/BloxFruits_25.html"))() end})

-- ===== Grow A Garden Tab =====
local GrowGardenTab = Window:CreateTab("Grow A Garden", 4483362458)
GrowGardenTab:CreateButton({Name = "Grow Hub", Callback = function() loadstring(game:HttpGet("URL_HUB_GROW_A_GARDEN"))() end})

-- ===== 99 Night In The Forest Tab =====
local ForestTab = Window:CreateTab("99 Night In The Forest", 4483362458)
ForestTab:CreateButton({Name = "Forest Hub", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/duytoan429/ForestHub/main/99Night.lua"))() end})

-- ===== Crossover Tab =====
local CrossoverTab = Window:CreateTab("Crossover", 4483362458)
CrossoverTab:CreateButton({Name = "Goomba Hub (Arise Crossover)", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/JustLevel/goombahub/main/AriseCrossover.lua"))() end})

-- ===== Steal a Brainrot Tab =====
local BrainrotTab = Window:CreateTab("Steal a Brainrot", 4483362458)
local function AddButton(tab, data) tab:CreateButton({Name=data.Name, Callback=data.Callback}) end
AddButton(BrainrotTab, {Name="Kurd hub", Callback=function() loadstring(game:HttpGet("https://raw.githubusercontent.com/Ninja10908/S4/refs/heads/main/Kurdhub"))() end})
AddButton(BrainrotTab, {Name="Lemon hub", Callback=function() loadstring(game:HttpGet("https://pastefy.app/MJw2J4T6/raw"))() end})
AddButton(BrainrotTab, {Name="Chilli hub", Callback=function() loadstring(game:HttpGet("https://raw.githubusercontent.com/tienkhanh1/spicy/main/Chilli.lua"))() end})

-- ===== Aim bot Tab =====
local aimEnabled = false
local fovRadius = 120
local aimSmooth = 0.35
local MIN_FOV, MAX_FOV = 20, 1000
local MIN_SMOOTH, MAX_SMOOTH = 0.01, 1
local wallCheckEnabled = true
local whitelist = {workspace.Terrain}

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AimBot_FOVGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
local fovFrame = Instance.new("Frame", screenGui)
fovFrame.AnchorPoint = Vector2.new(0.5,0.5)
fovFrame.Position = UDim2.new(0.5,0,0.5,0)
fovFrame.BackgroundTransparency = 1
fovFrame.Visible = false
local fovStroke = Instance.new("UIStroke", fovFrame)
fovStroke.Thickness = 2
fovStroke.Transparency = 0.3
local fovCorner = Instance.new("UICorner", fovFrame)
fovCorner.CornerRadius = UDim.new(1,0)

local function updateFOVVisual()
    local diameter = math.clamp(fovRadius*2, MIN_FOV, MAX_FOV)
    fovFrame.Size = UDim2.new(0, diameter, 0, diameter)
end
updateFOVVisual()

local hue = 0
RunService.RenderStepped:Connect(function(dt) hue=(hue+dt*0.2)%1; fovStroke.Color=Color3.fromHSV(hue,1,1) end)

local function isVisible(part)
    if not part or not part.Parent then return false end
    if not wallCheckEnabled then return true end
    local origin = Camera.CFrame.Position
    local direction = part.Position - origin
    local rayParams = RaycastParams.new()
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character, unpack(whitelist)}
    local result = workspace:Raycast(origin,direction,rayParams)
    if result then return result.Instance:IsDescendantOf(part.Parent) end
    return true
end

RunService.RenderStepped:Connect(function()
    if aimEnabled then
        local center=Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
        local bestPart,bestDist=nil,math.huge
        for _,player in pairs(Players:GetPlayers()) do
            if player~=LocalPlayer and player.Character and player.Character:FindFirstChild("Head") and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health>0 then
                local head = player.Character.Head
                local screenPos,onScreen=Camera:WorldToViewportPoint(head.Position)
                local d=(Vector2.new(screenPos.X,screenPos.Y)-center).Magnitude
                if onScreen and d<=fovRadius and d<bestDist and isVisible(head) then bestDist=d; bestPart=head end
            end
        end
        if bestPart then Camera.CFrame=Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position,bestPart.Position),aimSmooth) end
    end
end)

local AimTab = Window:CreateTab("Aim bot", 4483362458)
AimTab:CreateToggle({Name="Aimbot", CurrentValue=aimEnabled, Callback=function(v) aimEnabled=v; fovFrame.Visible=v end})
AimTab:CreateToggle({Name="Wall Check", CurrentValue=wallCheckEnabled, Callback=function(v) wallCheckEnabled=v end})
AimTab:CreateButton({Name="Reset Defaults", Callback=function() aimEnabled=false; fovRadius=120; aimSmooth=0.35; wallCheckEnabled=true; fovFrame.Visible=false; updateFOVVisual() end})
AimTab:CreateSlider({Name="FOV (pixels)", Range={MIN_FOV,MAX_FOV}, Increment=10, CurrentValue=fovRadius, Callback=function(v) fovRadius=v; updateFOVVisual() end})
AimTab:CreateSlider({Name="Aim Smooth", Range={MIN_SMOOTH,MAX_SMOOTH}, Increment=0.01, CurrentValue=aimSmooth, Callback=function(v) aimSmooth=v end})

-- ===== ESP Tab (thay bằng Box + Line) =====
local ESPTab = Window:CreateTab("ESP", 4483362458)
local espBoxEnabled=false
local espLineEnabled=false
local espTable={}
local linesTable={}

local function getTeamColor(player)
    if player.Team and player.Team.TeamColor then
        return player.Team.TeamColor.Color
    end
    return Color3.fromRGB(255,255,255)
end

local function createESPBox(player)
    if player==LocalPlayer or espTable[player] then return end
    local box = Drawing.new("Square")
    box.Thickness=1
    box.Filled=false
    local name = Drawing.new("Text"); name.Size=12; name.Center=true; name.Outline=true
    local distTxt = Drawing.new("Text"); distTxt.Size=14; distTxt.Center=true; distTxt.Outline=true; distTxt.Color=Color3.fromRGB(255,255,255)
    espTable[player] = {box=box, name=name, dist=distTxt}
end

local function removeESPBox(player)
    local data = espTable[player]
    if not data then return end
    pcall(function() data.box:Remove() end)
    pcall(function() data.name:Remove() end)
    pcall(function() data.dist:Remove() end)
    espTable[player]=nil
end

for _,pl in ipairs(Players:GetPlayers()) do createESPBox(pl) end
Players.PlayerAdded:Connect(createESPBox)
Players.PlayerRemoving:Connect(removeESPBox)

local function worldToViewportVec(pos)
    local p, onScreen = Camera:WorldToViewportPoint(pos)
    return Vector2.new(p.X, p.Y), onScreen, p.Z
end

-- ===== ESP Line (sửa, top screen) =====
local function createLine()
    local line = Drawing.new("Line")
    line.Thickness = 2
    line.Visible = false
    return line
end

local function removeLine(player)
    if linesTable[player] then
        linesTable[player]:Remove()
        linesTable[player] = nil
    end
end

Players.PlayerRemoving:Connect(removeLine)

RunService.RenderStepped:Connect(function()
    for player,data in pairs(espTable) do
        local char = player.Character
        if espBoxEnabled and char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Head") then
            local root, head = char.HumanoidRootPart, char.Head
            local topPos, topVis = worldToViewportVec(head.Position + Vector3.new(0,0.5,0))
            local bottomPos, botVis = worldToViewportVec(root.Position - Vector3.new(0,3,0))
            local centerPos, cenVis = worldToViewportVec(root.Position)

            if topVis and botVis and cenVis then
                local height = math.abs(bottomPos.Y - topPos.Y) * 1.5
                local width = height / 2
                local x, y = centerPos.X - width/2, topPos.Y

                data.box.Size = Vector2.new(width, height)
                data.box.Position = Vector2.new(x, y)
                data.box.Color = getTeamColor(player)
                data.box.Visible = true

                data.name.Text = player.Name
                data.name.Position = Vector2.new(centerPos.X, topPos.Y - 14)
                data.name.Color = getTeamColor(player)
                data.name.Visible = true

                local dist = math.floor((LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    and (LocalPlayer.Character.HumanoidRootPart.Position - root.Position).Magnitude) or 0)
                data.dist.Text = "["..dist.." studs]"
                data.dist.Position = Vector2.new(centerPos.X, bottomPos.Y + 14)
                data.dist.Visible = true
            else
                data.box.Visible, data.name.Visible, data.dist.Visible = false, false, false
            end
        else
            data.box.Visible, data.name.Visible, data.dist.Visible = false, false, false
        end
    end

    -- ESP Line
    for _,player in pairs(Players:GetPlayers()) do
        if espLineEnabled and player~=LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
            if not linesTable[player] then linesTable[player] = createLine() end
            local headPos, onScreen = Camera:WorldToViewportPoint(player.Character.Head.Position + Vector3.new(0,0.5,0))
            if onScreen then
                -- Bắt đầu từ top màn hình, y = 50
                linesTable[player].From = Vector2.new(Camera.ViewportSize.X/2, 50)
                linesTable[player].To = Vector2.new(headPos.X, headPos.Y)
                linesTable[player].Color = getTeamColor(player)
                linesTable[player].Visible = true
            else
                linesTable[player].Visible = false
            end
        elseif linesTable[player] then
            linesTable[player].Visible = false
        end
    end
end)

ESPTab:CreateToggle({Name="ESP Box", CurrentValue=false, Callback=function(v) espBoxEnabled=v end})
ESPTab:CreateToggle({Name="ESP Line", CurrentValue=false, Callback=function(v) espLineEnabled=v end})

-- ===== Other Tab =====
local OtherTab = Window:CreateTab("Khác", 4483362458)
local InfiniteJumpEnabled=false
OtherTab:CreateToggle({Name="Infinity Jump", CurrentValue=false, Callback=function(v) InfiniteJumpEnabled=v end})
UserInputService.JumpRequest:Connect(function() if InfiniteJumpEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then LocalPlayer.Character:FindFirstChildOfClass("Humanoid"):ChangeState("Jumping") end end)

OtherTab:CreateSlider({Name="Player Speed", Range={16,200}, Increment=5, CurrentValue=16, Callback=function(v) if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then LocalPlayer.Character:FindFirstChildOfClass("Humanoid").WalkSpeed=v end end})

local noclipEnabled=false
local noclipConnection
OtherTab:CreateToggle({Name="Noclip (xuyên vật thể)", CurrentValue=false, Callback=function(v)
    noclipEnabled=v
    if noclipEnabled then
        noclipConnection=RunService.Stepped:Connect(function() if LocalPlayer.Character then for _,p in pairs(LocalPlayer.Character:GetChildren()) do if p:IsA("BasePart") then p.CanCollide=false end end end end)
    elseif noclipConnection then noclipConnection:Disconnect(); noclipConnection=nil end
end})

OtherTab:CreateToggle({Name="Fly Gui", CurrentValue=false, Callback=function(v) if v then loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))() end end})

-- ===== Orbit Behind Player (in Other Tab) =====
local orbitEnabled=false
local distanceBehind=5
local bodyPos
local currentTarget=nil

OtherTab:CreateToggle({Name="Orbit Behind Player", CurrentValue=false, Callback=function(v)
    orbitEnabled=v
    local character=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local rootPart=character:WaitForChild("HumanoidRootPart")
    if orbitEnabled and not bodyPos then
        bodyPos=Instance.new("BodyPosition")
        bodyPos.MaxForce=Vector3.new(1e5,1e5,1e5)
        bodyPos.D=10
        bodyPos.P=3000
        bodyPos.Parent=rootPart
    elseif not orbitEnabled and bodyPos then bodyPos:Destroy(); bodyPos=nil end
end})

OtherTab:CreateSlider({Name="Orbit Distance", Range={1,20}, Increment=1, CurrentValue=distanceBehind, Callback=function(v) distanceBehind=v end})

local function getClosestAlivePlayer()
    local closestDist,closestPlayer=math.huge,nil
    for _,player in pairs(Players:GetPlayers()) do
        if player~=LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health>0 then
            local dist=(player.Character.HumanoidRootPart.Position-LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            if dist<closestDist then closestDist=dist; closestPlayer=player end
        end
    end
    return closestPlayer
end

RunService.RenderStepped:Connect(function()
    if orbitEnabled then
        local character=LocalPlayer.Character
        if not character or not character:FindFirstChild("HumanoidRootPart") then return end
        if not currentTarget or not currentTarget.Character or not currentTarget.Character:FindFirstChild("HumanoidRootPart") then
            currentTarget=getClosestAlivePlayer()
        end
        if currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild("HumanoidRootPart") and bodyPos then
            local targetRoot=currentTarget.Character.HumanoidRootPart
            local backPos=targetRoot.Position-targetRoot.CFrame.LookVector*distanceBehind
            bodyPos.Position=backPos
        end
    end
end)

-- ===== Platform Tab =====
local PlatformTab = Window:CreateTab("Platform", 4483362458)
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

local blox = Instance.new("Part")
blox.Size = Vector3.new(6,0.2,6)
blox.Anchored = true
blox.CanCollide = false
blox.BrickColor = BrickColor.new("Bright red")
blox.Transparency = 1
blox.Parent = workspace

local blockEnabled=false
local heelOffset=2
local lerpSpeed=0.1

PlatformTab:CreateToggle({Name="Enable Platform", CurrentValue=false, Callback=function(v) blockEnabled=v; blox.Transparency=(v and 0 or 1); blox.CanCollide=v end})

RunService.RenderStepped:Connect(function()
    if blockEnabled and humanoidRootPart then
        local hrpPos=humanoidRootPart.Position
        local hrpY=humanoidRootPart.Size.Y/2
        local bloxY=blox.Size.Y/2
        local targetY=hrpPos.Y-hrpY-heelOffset-bloxY
        local newY=blox.Position.Y+(targetY-blox.Position.Y)*lerpSpeed
        blox.Position=Vector3.new(hrpPos.X,newY,hrpPos.Z)
    end
end)
