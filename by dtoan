-- ===== Menu Dtoan cơ bản =====
local Dtoan = loadstring(game:HttpGet('https://raw.githubusercontent.com/duytoan429/Menu/refs/heads/main/sourcebydtoan.lua.txt'))()
local Window = Dtoan:CreateWindow({
    Name = "Dtoan",
    Icon = 0,
    LoadingTitle = "Dtoan",
    Theme = "Default",
    ToggleUIKeybind = "K",
    DisableDtoanPrompts = false,
    DisableBuildWarnings = false,

    ConfigurationSaving = {
        Enabled = true,
        FolderName = nil,
        FileName = "Dtoan Hub"
    },

    Discord = {
        Enabled = false,
        Invite = "https://discord.gg/9Xhw2AMKw",
        RememberJoins = true
    },

    KeySystem = false,
    KeySettings = {
        Title = "Untitled",
        FileName = "Key",
        SaveKey = true,
        GrabKeyFromSite = false,
        Key = {"Hello"}
    }
})

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ===== Variables =====
-- Aim bot
local aimEnabled = false
local fovRadius = 120
local aimSmooth = 0.35
local MIN_FOV, MAX_FOV = 20, 1000
local MIN_SMOOTH, MAX_SMOOTH = 0.01, 1
local wallCheckEnabled = true -- Toggle riêng cho Wall Check
local whitelist = {workspace.Terrain}

-- ESP
local espEnabled = false  -- mặc định tắt
_G.FriendColor = Color3.fromRGB(0,0,255)
_G.EnemyColor = Color3.fromRGB(255,0,0)
_G.UseTeamColor = true

-- ===== FOV Circle =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AimBot_FOVGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local fovFrame = Instance.new("Frame", screenGui)
fovFrame.AnchorPoint = Vector2.new(0.5, 0.5)
fovFrame.Position = UDim2.new(0.5,0,0.5,0)
fovFrame.BackgroundTransparency = 1
fovFrame.Visible = false

local fovStroke = Instance.new("UIStroke", fovFrame)
fovStroke.Thickness = 2
fovStroke.Transparency = 0.3
local fovCorner = Instance.new("UICorner", fovFrame)
fovCorner.CornerRadius = UDim.new(1,0)

local function updateFOVVisual()
    local diameter = math.clamp(fovRadius*2, MIN_FOV, MAX_FOV)
    fovFrame.Size = UDim2.new(0, diameter, 0, diameter)
    fovFrame.Position = UDim2.new(0.5,0,0.5,0)
end
updateFOVVisual()

-- Rainbow stroke
local hue = 0
RunService.RenderStepped:Connect(function(dt)
    hue = (hue + dt*0.2) % 1
    fovStroke.Color = Color3.fromHSV(hue,1,1)
end)

-- ===== ESP Function =====
local function applyESP(player)
    if not player.Character then return end
    local color
    if _G.UseTeamColor then
        color = player.TeamColor.Color
    else
        color = (player.TeamColor == LocalPlayer.TeamColor) and _G.FriendColor or _G.EnemyColor
    end
    if not player.Character:FindFirstChild("GetReal") then
        local highlight = Instance.new("Highlight")
        highlight.Name = "GetReal"
        highlight.RobloxLocked = true
        highlight.Adornee = player.Character
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.FillColor = color
        highlight.OutlineColor = Color3.new(0,0,0)
        highlight.Parent = player.Character
    else
        player.Character.GetReal.FillColor = color
    end
end

-- ===== Aim bot Wall Check Function =====
local function isVisible(part)
    if not part or not part.Parent then return false end
    if not wallCheckEnabled then return true end -- nếu tắt Wall Check thì luôn true
    local origin = Camera.CFrame.Position
    local direction = part.Position - origin
    local rayParams = RaycastParams.new()
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character, unpack(whitelist)}
    local result = workspace:Raycast(origin, direction, rayParams)
    if result then
        return result.Instance:IsDescendantOf(part.Parent)
    end
    return true
end

-- ===== Update Loop =====
RunService.RenderStepped:Connect(function()
    -- ESP update
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if espEnabled then
                applyESP(player)
            elseif player.Character and player.Character:FindFirstChild("GetReal") then
                player.Character.GetReal:Destroy()
            end
        end
    end

    -- Aim bot
    if aimEnabled then
        local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
        local bestPart, bestDist = nil, math.huge

        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health>0 then
                local head = player.Character.Head
                local screenPos, onScreen = Camera:WorldToViewportPoint(head.Position)
                local d = (Vector2.new(screenPos.X, screenPos.Y) - center).Magnitude
                if onScreen and d <= fovRadius and d < bestDist and isVisible(head) then
                    bestDist = d
                    bestPart = head
                end
            end
        end

        if bestPart then
            Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position, bestPart.Position), aimSmooth)
        end
    end
end)

-- ===== Aim bot GUI Tab =====
local AimTab = Window:CreateTab("Aim bot", 4483362458)

local AimbotToggle = AimTab:CreateToggle({
    Name = "Aimbot",
    CurrentValue = aimEnabled,
    Flag = "Aimbot_Toggle",
    Callback = function(Value)
        aimEnabled = Value
        fovFrame.Visible = Value
    end,
})

local WallCheckToggle = AimTab:CreateToggle({
    Name = "Wall Check",
    CurrentValue = wallCheckEnabled,
    Flag = "WallCheck_Toggle",
    Callback = function(Value)
        wallCheckEnabled = Value
    end,
})

local ResetAimButton = AimTab:CreateButton({
    Name = "Reset Defaults",
    Callback = function()
        aimEnabled = false
        fovRadius = 120
        aimSmooth = 0.35
        wallCheckEnabled = true
        fovFrame.Visible = aimEnabled
        updateFOVVisual()
    end,
})

local FOVSlider = AimTab:CreateSlider({
    Name = "FOV (pixels)",
    Range = {MIN_FOV, MAX_FOV},
    Increment = 10,
    CurrentValue = fovRadius,
    Flag = "FOVSlider",
    Callback = function(Value)
        fovRadius = math.clamp(Value, MIN_FOV, MAX_FOV)
        updateFOVVisual()
    end,
})

local AimSmoothSlider = AimTab:CreateSlider({
    Name = "Aim Smooth",
    Range = {MIN_SMOOTH, MAX_SMOOTH},
    Increment = 0.01,
    CurrentValue = aimSmooth,
    Flag = "AimSmoothSlider",
    Callback = function(Value)
        aimSmooth = math.clamp(Value, MIN_SMOOTH, MAX_SMOOTH)
    end,
})

-- ===== ESP GUI Tab =====
local ESPTab = Window:CreateTab("ESP", 4483362458)

local ESPEnableToggle = ESPTab:CreateToggle({
    Name = "Enable ESP",
    CurrentValue = espEnabled,
    Flag = "ESP_Toggle",
    Callback = function(Value)
        espEnabled = Value
    end,
})

local FriendColorPicker = ESPTab:CreateColorPicker({
    Name = "Friend Color",
    Color = _G.FriendColor,
    Flag = "FriendColorPicker",
    Callback = function(Value)
        _G.FriendColor = Value
    end,
})

local EnemyColorPicker = ESPTab:CreateColorPicker({
    Name = "Enemy Color",
    Color = _G.EnemyColor,
    Flag = "EnemyColorPicker",
    Callback = function(Value)
        _G.EnemyColor = Value
    end,
})

local UseTeamColorToggle = ESPTab:CreateToggle({
    Name = "Use Team Color",
    CurrentValue = _G.UseTeamColor,
    Flag = "UseTeamColor",
    Callback = function(Value)
        _G.UseTeamColor = Value
    end,
})

-- ===== Khác Tab =====
local OtherTab = Window:CreateTab("Khác", 4483362458)

-- Infinity Jump
local InfiniteJumpEnabled = false
local InfinityJumpToggle = OtherTab:CreateToggle({
    Name = "Infinity Jump",
    CurrentValue = false,
    Flag = "InfinityJump_Toggle",
    Callback = function(Value)
        InfiniteJumpEnabled = Value
    end,
})

UserInputService.JumpRequest:Connect(function()
    if InfiniteJumpEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
        LocalPlayer.Character:FindFirstChildOfClass("Humanoid"):ChangeState("Jumping")
    end
end)

-- Player Speed
local SpeedSlider = OtherTab:CreateSlider({
    Name = "Player Speed",
    Range = {16, 200},
    Increment = 5,
    CurrentValue = 16,
    Flag = "PlayerSpeedSlider",
    Callback = function(Value)
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
            LocalPlayer.Character:FindFirstChildOfClass("Humanoid").WalkSpeed = Value
        end
    end,
})

-- Noclip
local noclipEnabled = false
local noclipConnection
local NoclipToggle = OtherTab:CreateToggle({
    Name = "Noclip (xuyên vật thể)",
    CurrentValue = false,
    Flag = "NoclipToggle",
    Callback = function(Value)
        noclipEnabled = Value
        if noclipEnabled then
            noclipConnection = RunService.Stepped:Connect(function()
                if LocalPlayer.Character then
                    for _, part in pairs(LocalPlayer.Character:GetChildren()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = false
                        end
                    end
                end
            end)
        else
            if noclipConnection then
                noclipConnection:Disconnect()
                noclipConnection = nil
            end
        end
    end,
})

-- Fly Gui Toggle
local FlyGuiToggle = OtherTab:CreateToggle({
    Name = "Fly Gui",
    CurrentValue = false,
    Flag = "FlyGui_Toggle",
    Callback = function(Value)
        if Value then
            loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))()
        end
    end,
})

-- ===== Init =====
fovFrame.Visible = aimEnabled
updateFOVVisual()
